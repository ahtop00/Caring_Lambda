# ì›Œí¬í”Œë¡œìš° ì´ë¦„
name: Deploy Chatbot Lambda to AWS

# ì–¸ì œ ì‹¤í–‰í• ì§€ ì •ì˜: main ë¸Œëœì¹˜ì— pushë  ë•Œ
on:
  push:
    branches:
      - main
    # ğŸ’¡ í•µì‹¬: chatbot/ ë””ë ‰í† ë¦¬ ì•ˆì˜ íŒŒì¼ì´ ë³€ê²½ë˜ì—ˆì„ ë•Œë§Œ ì´ ì›Œí¬í”Œë¡œìš°ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.
    paths:
      - 'chatbot/**'

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write # AWS OIDC ì¸ì¦ì„ ìœ„í•´ í•„ìš”
      contents: read

    steps:
      # 1. GitHub ì €ì¥ì†Œì˜ ì½”ë“œë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Python í™˜ê²½ì„ ì„¤ì •í•©ë‹ˆë‹¤.
      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: 3.12

      # 3. ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì„¤ì¹˜í•˜ê³  ë°°í¬ìš© zip íŒŒì¼ì„ ìƒì„±í•©ë‹ˆë‹¤.
      - name: Install dependencies and create ZIP file
        run: |
          # chatbot ë””ë ‰í† ë¦¬ë¡œ ì´ë™
          cd chatbot
          # requirements.txtì— ëª…ì‹œëœ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ í˜„ì¬ ë””ë ‰í† ë¦¬ì— ì„¤ì¹˜
          pip install -r requirements.txt -t .
          # ì„¤ì¹˜ëœ ë¼ì´ë¸ŒëŸ¬ë¦¬ì™€ ëª¨ë“  ì†ŒìŠ¤ ì½”ë“œë¥¼ í•¨ê»˜ ì••ì¶•
          zip -r ../deploy-chatbot.zip .

      # 4. AWS ìê²© ì¦ëª…ì„ ì„¤ì •í•©ë‹ˆë‹¤. (IAM Role ì‚¬ìš© ê¶Œì¥)
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          # âš ï¸ IAM ì—­í•  ARNì„ ì—¬ê¸°ì— ì…ë ¥í•˜ì„¸ìš”.
          role-to-assume: arn:aws:iam::084056488795:role/GitHubActions-Lambda-DeployRole
          aws-region: ap-northeast-2

      # 5. AWS CLIë¥¼ ì‚¬ìš©í•´ Lambda í•¨ìˆ˜ ì½”ë“œë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
      - name: Deploy to AWS Lambda
        run: |
          aws lambda update-function-code \
            --function-name YOUR_CHATBOT_LAMBDA_NAME \
            --zip-file fileb://deploy-chatbot.zip
